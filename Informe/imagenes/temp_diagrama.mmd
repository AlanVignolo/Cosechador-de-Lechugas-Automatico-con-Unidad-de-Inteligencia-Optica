%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#f5f5f5','primaryTextColor':'#000','primaryBorderColor':'#424242','lineColor':'#616161','secondaryColor':'#fafafa','tertiaryColor':'#f5f5f5','fontSize':'20px','fontFamily':'Arial, sans-serif'}}}%%

flowchart LR
    Start([INICIO]):::startEnd
    
    subgraph Inicial["INICIALIZACIÓN"]
        LoadMaps[Cargar tubos<br/>y cintas JSON]:::process
        CheckHoming{Robot<br/>homed?}:::decision
        DoHoming[Ejecutar<br/>homing]:::process
        ArmSafe[Brazo a posición<br/>segura]:::process
    end
    
    subgraph Navegacion["NAVEGACIÓN Y CLASIFICACIÓN"]
        LoopTubes[Para cada<br/>tubo]:::loop
        LoopBelts[Para cada<br/>cinta]:::loop
        Navigate[Mover a<br/>X_cinta, Y_tubo]:::process
        ClassifyIA{Clasificar IA<br/>Estado?}:::decision
        Empty[VACÍO<br/>Continuar]:::skip
        NotReady[NO LISTA<br/>Continuar]:::skip
    end
    
    subgraph Cosecha["COSECHA Y TRANSPORTE"]
        CorrectPos[Corrección<br/>posición IA]:::critical
        Pick[Recoger lechuga<br/>extender + cerrar]:::critical
        Transport[Mover lechuga<br/>con planta]:::critical
    end
    
    subgraph Deposito["DEPÓSITO"]
        MoveDeposit[Mover a zona<br/>depósito]:::process
        Deposit[Depositar lechuga<br/>inclinar + abrir]:::critical
        ReturnArm[Retornar brazo<br/>sin planta]:::critical
    end
    
    subgraph Control["CONTROL FLUJO"]
        MoreBelts{Más<br/>cintas?}:::decision
        ReturnOrigin[Volver a<br/>origen 0,0]:::process
    end
    
    End([FIN]):::startEnd
    
    Start --> LoadMaps
    LoadMaps --> CheckHoming
    CheckHoming -->|NO| DoHoming
    DoHoming --> ArmSafe
    CheckHoming -->|SÍ| ArmSafe
    ArmSafe --> LoopTubes
    LoopTubes --> LoopBelts
    LoopBelts --> Navigate
    Navigate --> ClassifyIA
    ClassifyIA -->|VACÍO| Empty
    ClassifyIA -->|NO LISTA| NotReady
    ClassifyIA -->|LISTA| CorrectPos
    CorrectPos --> Pick
    Pick --> Transport
    Transport --> MoveDeposit
    MoveDeposit --> Deposit
    Deposit --> ReturnArm
    ReturnArm --> MoreBelts
    Empty --> MoreBelts
    NotReady --> MoreBelts
    MoreBelts -->|SÍ| LoopBelts
    MoreBelts -->|NO| ReturnOrigin
    ReturnOrigin --> End
    
    classDef startEnd fill:#2E7D32,stroke:#1B5E20,stroke-width:4px,color:#fff,font-weight:bold,font-size:18px
    classDef process fill:#1565C0,stroke:#0D47A1,stroke-width:3px,color:#fff,font-weight:bold,font-size:16px
    classDef decision fill:#D84315,stroke:#BF360C,stroke-width:3px,color:#fff,font-weight:bold,font-size:16px
    classDef critical fill:#6A1B9A,stroke:#4A148C,stroke-width:3px,color:#fff,font-weight:bold,font-size:16px
    classDef skip fill:#616161,stroke:#424242,stroke-width:3px,color:#fff,font-size:16px
    classDef loop fill:#00838F,stroke:#006064,stroke-width:3px,color:#fff,font-weight:bold,font-size:16px

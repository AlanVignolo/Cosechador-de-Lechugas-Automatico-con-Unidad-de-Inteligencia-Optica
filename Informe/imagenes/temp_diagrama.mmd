%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#f5f5f5','primaryTextColor':'#000','primaryBorderColor':'#424242','lineColor':'#616161','secondaryColor':'#fafafa','tertiaryColor':'#f5f5f5'}}}%%

flowchart TB
    Start([INICIO]):::startEnd
    LoadMaps[Cargar tubos y cintas JSON]:::process
    CheckHoming{¿Robot homed?}:::decision

    %% Nodos a los costados de CheckHoming
    DoHoming[Ejecutar homing]:::process
    ArmSafe[Brazo → posición segura]:::process

    %% Loops lado a lado
    LoopTubes[Para cada tubo]:::loop
    LoopBelts[Para cada cinta]:::loop
    Navigate[Mover a X_cinta, Y_tubo]:::process

    ClassifyIA{Clasificar IA: ¿Estado?}:::decision

    %% Tres ramas lado a lado
    Empty[VACÍO<br/>Continuar]:::skip
    NotReady[NO LISTA<br/>Continuar]:::skip
    CorrectPos[Corrección posición IA]:::critical

    %% Proceso de cosecha en fila horizontal
    Pick[Recoger lechuga]:::critical
    Transport[Transportar]:::critical
    MoveDeposit[Mover a depósito]:::process
    Deposit[Depositar lechuga]:::critical
    ReturnArm[Retornar brazo]:::critical

    MoreBelts{¿Más cintas?}:::decision
    ReturnOrigin[Volver a origen 0,0]:::process
    End([FIN]):::startEnd

    %% Conexiones
    Start --> LoadMaps --> CheckHoming
    CheckHoming -->|NO| DoHoming --> ArmSafe
    CheckHoming -->|SÍ| ArmSafe

    ArmSafe --> LoopTubes --> LoopBelts --> Navigate --> ClassifyIA

    %% Ramificación horizontal de los 3 casos
    ClassifyIA -->|VACÍO| Empty
    ClassifyIA -->|NO LISTA| NotReady
    ClassifyIA -->|LISTA| CorrectPos

    %% Los casos vacío y no lista van directo a MoreBelts
    Empty --> MoreBelts
    NotReady --> MoreBelts

    %% Proceso de cosecha en cadena horizontal
    CorrectPos --> Pick
    Pick --> Transport
    Transport --> MoveDeposit
    MoveDeposit --> Deposit
    Deposit --> ReturnArm
    ReturnArm --> MoreBelts

    %% Loop final
    MoreBelts -->|SÍ| LoopBelts
    MoreBelts -->|NO| ReturnOrigin --> End

    classDef startEnd fill:#2E7D32,stroke:#1B5E20,stroke-width:3px,color:#fff,font-weight:bold
    classDef process fill:#1565C0,stroke:#0D47A1,stroke-width:2px,color:#fff,font-weight:bold
    classDef decision fill:#D84315,stroke:#BF360C,stroke-width:2px,color:#fff,font-weight:bold
    classDef critical fill:#6A1B9A,stroke:#4A148C,stroke-width:2px,color:#fff,font-weight:bold
    classDef skip fill:#616161,stroke:#424242,stroke-width:2px,color:#fff
    classDef loop fill:#00838F,stroke:#006064,stroke-width:2px,color:#fff,font-weight:bold
